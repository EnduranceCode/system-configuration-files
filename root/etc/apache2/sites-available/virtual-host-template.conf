#
# Apache Virtual Host Configuration Template
# ==========================================
#
# This template provides configuration blocks for an Apache VirtualHost. It handles both main domain
# and subdomain access. It also includes a 'WWW' to non-WWW redirect. If this is not a desired
# behavior the section must be removed.
#
# If a subdomain is not in use, the corresponding section should be removed. If more than one
# subdomain is required, simply copy and paste the subdomain section and modify it accordingly.
#
# This template also provides configuration blocks to set up the Apache server as a reverse proxy.
# It handles both main domain and subdomain with proper redirects and headers. Remove
# the corresponding section(s) if Reverse Proxy functionality is not required.
#
# If more than one subdomain is required for the reverse proxy, simply copy and paste the
# subdomain section and modify it accordingly.
#
# REPLACEMENT GUIDE:
# ------------------
# Replace ALL placeholder tags {PLACEHOLDER} with the actual values:
#
# DOMAIN CONFIGURATION:
#   {THIRD_LEVEL_DOMAIN}      - The subdomain name (e.g., 'api' in api.example.com)
#   {SECOND_LEVEL_DOMAIN_SLD} - The domain name (e.g., 'example' in example.com)
#   {TOP_LEVEL_DOMAIN_TLD}    - The top-level domain (e.g., 'com', 'org', 'net')
#
# APPLICATION PORT:
#   {APP_PORT}                - External port where the app runs (e.g., 8080, 8081)
#
# SERVER ADMIN:
#   {SERVER_ADMIN_EMAIL}      - Administrator email for server notifications
#
# REQUIRED APACHE MODULES:
# ------------------------
# These modules are typically enabled by default in Apache 2.4:
# - mod_alias (for Redirect directive)
# - mod_dir (for Directory handling)
# - mod_log_config (for logging)
#
# Optional but recommended for enhanced features:
# sudo a2enmod headers       # For security headers
# sudo a2enmod rewrite       # For advanced URL rewriting
#
# Required for Reverse Proxy functionality:
# sudo a2enmod proxy
# sudo a2enmod proxy_http
# sudo a2enmod headers
#
# FILE PATHS:
# -----------
# DocumentRoot paths assume a standard structure at /srv/www/ and its existence must be ensured
# as well as proper permissions.
# Example: /srv/www/example for example.com and /srv/www/example-api for api.example.com
#
# IMPORTANT NOTES:
# ----------------
# 1. Test configuration after editing: sudo apachectl configtest
# 2. Reload Apache after changes: sudo systemctl reload apache2
#

# --------------------------------------------------------------------------------------------------
# WWW to non-WWW redirects
# --------------------------------------------------------------------------------------------------

<VirtualHost *:80>
    ServerName www.{SECOND_LEVEL_DOMAIN_SLD}.{TOP_LEVEL_DOMAIN_TLD}
    Redirect permanent / http://{SECOND_LEVEL_DOMAIN_SLD}.{TOP_LEVEL_DOMAIN_TLD}/

    ServerAdmin {SERVER_ADMIN_EMAIL}

    ErrorLog ${APACHE_LOG_DIR}/{SECOND_LEVEL_DOMAIN_SLD}_www_redirect_error.log
    LogLevel warn
</VirtualHost>

# --------------------------------------------------------------------------------------------------
# Static Configuration
# --------------------------------------------------------------------------------------------------

# Main domain
<VirtualHost *:80>
    ServerName {SECOND_LEVEL_DOMAIN_SLD}.{TOP_LEVEL_DOMAIN_TLD}

    ServerAdmin {SERVER_ADMIN_EMAIL}

    DocumentRoot /srv/www/{SECOND_LEVEL_DOMAIN_SLD}

    # Directory configuration
    <Directory /srv/www/{SECOND_LEVEL_DOMAIN_SLD}>
        Options -Indexes +FollowSymLinks -MultiViews
        # Change to AllowOverride All if runtime configuration via .htaccess is necessary
        AllowOverride None
        Require all granted

        # Security headers
        <IfModule mod_headers.c>
            Header always set X-Content-Type-Options "nosniff"
            Header always set X-Frame-Options "SAMEORIGIN"
        </IfModule>
    </Directory>

    LogLevel warn
    ErrorLog ${APACHE_LOG_DIR}/{SECOND_LEVEL_DOMAIN_SLD}_error.log
    CustomLog ${APACHE_LOG_DIR}/{SECOND_LEVEL_DOMAIN_SLD}_access.log combined
</VirtualHost>

# Subdomain
<VirtualHost *:80>
    ServerName {THIRD_LEVEL_DOMAIN}.{SECOND_LEVEL_DOMAIN_SLD}.{TOP_LEVEL_DOMAIN_TLD}

    ServerAdmin {SERVER_ADMIN_EMAIL}

    # Use hyphenated directory naming convention starting from the second-level domain
    DocumentRoot /srv/www/{SECOND_LEVEL_DOMAIN_SLD}-{THIRD_LEVEL_DOMAIN}

    <Directory /srv/www/{SECOND_LEVEL_DOMAIN_SLD}-{THIRD_LEVEL_DOMAIN}>
        Options -Indexes +FollowSymLinks -MultiViews
        # Change to AllowOverride All if runtime configuration via .htaccess is necessary
        AllowOverride None
        Require all granted

        # Security headers
        <IfModule mod_headers.c>
            Header always set X-Content-Type-Options "nosniff"
            Header always set X-Frame-Options "SAMEORIGIN"
        </IfModule>
    </Directory>

    LogLevel warn
    ErrorLog ${APACHE_LOG_DIR}/{SECOND_LEVEL_DOMAIN_SLD}_{THIRD_LEVEL_DOMAIN}_error.log
    CustomLog ${APACHE_LOG_DIR}/{SECOND_LEVEL_DOMAIN_SLD}_{THIRD_LEVEL_DOMAIN}_access.log combined
</VirtualHost>

# --------------------------------------------------------------------------------------------------
# Reverse Proxy Configuration
# --------------------------------------------------------------------------------------------------

# Main domain
<VirtualHost *:80>
    ServerName {SECOND_LEVEL_DOMAIN_SLD}.{TOP_LEVEL_DOMAIN_TLD}

    ServerAdmin {SERVER_ADMIN_EMAIL}

    ProxyRequests Off

    # Connection Settings
    KeepAlive On
    KeepAliveTimeout 5
    MaxKeepAliveRequests 100
    Timeout 300

    # Forwarding configuration
    ProxyPreserveHost On
    ProxyPass / http://localhost:{APP_PORT}/
    ProxyPassReverse / http://localhost:{APP_PORT}/

    # Headers configuration
    RequestHeader set X-Forwarded-Proto "http"
    RequestHeader set X-Forwarded-Port "80"

    LogLevel warn
    ErrorLog ${APACHE_LOG_DIR}/{SECOND_LEVEL_DOMAIN_SLD}_proxy_error.log
    CustomLog ${APACHE_LOG_DIR}/{SECOND_LEVEL_DOMAIN_SLD}_proxy_access.log combined
</VirtualHost>

# Subdomain
<VirtualHost *:80>
    ServerName {THIRD_LEVEL_DOMAIN}.{SECOND_LEVEL_DOMAIN_SLD}.{TOP_LEVEL_DOMAIN_TLD}

    ServerAdmin {SERVER_ADMIN_EMAIL}

    ProxyRequests Off

    # Connection settings
    KeepAlive On
    KeepAliveTimeout 5
    MaxKeepAliveRequests 100
    Timeout 300

    # Forwarding configuration
    ProxyPreserveHost On
    ProxyPass / http://localhost:{APP_PORT}/
    ProxyPassReverse / http://localhost:{APP_PORT}/

    # Headers configuration
    RequestHeader set X-Forwarded-Proto "http"
    RequestHeader set X-Forwarded-Port "80"

    LogLevel warn
    ErrorLog ${APACHE_LOG_DIR}/{THIRD_LEVEL_DOMAIN}_{SECOND_LEVEL_DOMAIN_SLD}_proxy_error.log
    CustomLog ${APACHE_LOG_DIR}/{THIRD_LEVEL_DOMAIN}_{SECOND_LEVEL_DOMAIN_SLD}_proxy_access.log combined
</VirtualHost>
